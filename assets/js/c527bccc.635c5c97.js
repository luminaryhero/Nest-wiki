"use strict";(self.webpackChunknest_wiki=self.webpackChunknest_wiki||[]).push([[1154],{2790:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>i,default:()=>d,frontMatter:()=>o,metadata:()=>a,toc:()=>c});var s=t(1527),r=t(7540);const o={title:"\u901a\u7528\u529f\u80fd(\u56db)"},i=void 0,a={permalink:"/nest-wiki/blog/04",source:"@site/blog/04.md",title:"\u901a\u7528\u529f\u80fd(\u56db)",description:"- [x] \u9a8c\u8bc1\u7ba1\u9053",date:"2023-12-28T14:26:58.000Z",formattedDate:"December 28, 2023",tags:[],readingTime:2.325,hasTruncateMarker:!1,authors:[],frontMatter:{title:"\u901a\u7528\u529f\u80fd(\u56db)"},unlisted:!1,prevItem:{title:"\u914d\u7f6e\u6a21\u5757(\u4e09)",permalink:"/nest-wiki/blog/03"},nextItem:{title:"\u8ba4\u8bc1\u6388\u6743",permalink:"/nest-wiki/blog/05"}},l={authorsImageUrls:[]},c=[{value:"\u901a\u7528\u529f\u80fd",id:"\u901a\u7528\u529f\u80fd",level:2},{value:"\u9a8c\u8bc1\u7ba1\u9053",id:"\u9a8c\u8bc1\u7ba1\u9053",level:3},{value:"\u54cd\u5e94\u62e6\u622a",id:"\u54cd\u5e94\u62e6\u622a",level:3},{value:"\u5f02\u5e38\u5904\u7406",id:"\u5f02\u5e38\u5904\u7406",level:3},{value:"App \u6a21\u5757",id:"app-\u6a21\u5757",level:2},{value:"User \u6a21\u5757",id:"user-\u6a21\u5757",level:2}];function p(e){const n={blockquote:"blockquote",code:"code",h2:"h2",h3:"h3",input:"input",li:"li",p:"p",pre:"pre",ul:"ul",...(0,r.a)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(n.ul,{className:"contains-task-list",children:["\n",(0,s.jsxs)(n.li,{className:"task-list-item",children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.input,{type:"checkbox",checked:!0,disabled:!0})," ","\u9a8c\u8bc1\u7ba1\u9053"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{className:"task-list-item",children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.input,{type:"checkbox",checked:!0,disabled:!0})," ","\u54cd\u5e94\u62e6\u622a"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{className:"task-list-item",children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.input,{type:"checkbox",checked:!0,disabled:!0})," ","\u5f02\u5e38\u5904\u7406"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"\u901a\u7528\u529f\u80fd",children:"\u901a\u7528\u529f\u80fd"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"$ pnpm add class-validator class-transformer\n"})}),"\n",(0,s.jsx)(n.h3,{id:"\u9a8c\u8bc1\u7ba1\u9053",children:"\u9a8c\u8bc1\u7ba1\u9053"}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"commons/validation.pipe.ts"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:'import {\n  UsePipes,\n  ValidationPipe,\n  ValidationPipeOptions,\n} from "@nestjs/common";\n\nexport function UseValidation(group?: string) {\n  const options: ValidationPipeOptions = {\n    transform: true,\n    whitelist: true,\n    forbidNonWhitelisted: true,\n    forbidUnknownValues: false,\n    validationError: { target: false },\n  };\n  if (group) {\n    options.groups = [group];\n  }\n  return UsePipes(new ValidationPipe(options));\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"\u54cd\u5e94\u62e6\u622a",children:"\u54cd\u5e94\u62e6\u622a"}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"commons/transform.interceptor.ts"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:'import {\n  Injectable,\n  NestInterceptor,\n  ExecutionContext,\n  CallHandler,\n} from "@nestjs/common";\nimport { Observable } from "rxjs";\nimport { map } from "rxjs/operators";\n\nexport interface Response<T> {\n  code: number;\n  message: string;\n  ttl: number;\n  data: T;\n}\n\n@Injectable()\nexport class TransformInterceptor<T>\n  implements NestInterceptor<T, Response<T>>\n{\n  intercept(\n    context: ExecutionContext,\n    next: CallHandler\n  ): Observable<Response<T>> {\n    const now = Date.now();\n    return next.handle().pipe(\n      map((data) => ({\n        code: 0,\n        message: "ok",\n        ttl: Date.now() - now,\n        data,\n      }))\n    );\n  }\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"\u5f02\u5e38\u5904\u7406",children:"\u5f02\u5e38\u5904\u7406"}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"all-exception.filter.ts"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:'import {\n  ExceptionFilter,\n  Catch,\n  ArgumentsHost,\n  HttpException,\n  HttpStatus,\n} from "@nestjs/common";\nimport { HttpAdapterHost } from "@nestjs/core";\n\n@Catch()\nexport class AllExceptionsFilter<T extends Error>\n  implements ExceptionFilter<T>\n{\n  constructor(private readonly httpAdapterHost: HttpAdapterHost) {}\n\n  catch(exception: T, host: ArgumentsHost): void {\n    // In certain situations `httpAdapter` might not be available in the\n    // constructor method, thus we should resolve it here.\n    const { httpAdapter } = this.httpAdapterHost;\n\n    const ctx = host.switchToHttp();\n\n    let httpStatus, message;\n    if (exception instanceof HttpException) {\n      httpStatus = exception.getStatus();\n      message = (exception.getResponse() as any)?.message;\n    } else {\n      httpStatus = HttpStatus.INTERNAL_SERVER_ERROR;\n      message = exception.message;\n    }\n\n    const responseBody = {\n      code: -1,\n      message: message,\n      timestamp: new Date().toISOString(),\n      path: httpAdapter.getRequestUrl(ctx.getRequest()),\n    };\n\n    httpAdapter.reply(ctx.getResponse(), responseBody, httpStatus);\n  }\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"app-\u6a21\u5757",children:"App \u6a21\u5757"}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"app.module.ts"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"@Module({\n  imports: [UsersModule, DatabasesModule, ConfigurationsModule],\n  controllers: [],\n  providers: [\n    {\n      provide: APP_INTERCEPTOR,\n      useClass: TransformInterceptor,\n    },\n    {\n      provide: APP_FILTER,\n      useClass: AllExceptionsFilter,\n    },\n  ],\n})\nexport class AppModule {}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"user-\u6a21\u5757",children:"User \u6a21\u5757"}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"create-user.dto.ts"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:'import { IsBoolean, IsNotEmpty, IsOptional } from "class-validator";\n\nexport class CreateUserDto {\n  @IsNotEmpty({ groups: ["create"] })\n  @IsOptional({ groups: ["update"] })\n  firstName: string;\n\n  @IsNotEmpty({ groups: ["create"] })\n  @IsOptional({ groups: ["update"] })\n  lastName: string;\n\n  @IsBoolean({ always: true })\n  @IsOptional({ always: true })\n  isActive?: boolean;\n}\n'})}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"pagination.dto.ts"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:'import { IsOptional, Max, Min } from "class-validator";\nimport { Transform } from "class-transformer";\n\nexport class PagintionDto {\n  @Transform(({ value }) => Number(value))\n  @Min(1)\n  @Max(30)\n  @IsOptional()\n  limit?: number;\n\n  @Transform(({ value }) => Number(value))\n  @Min(1)\n  @IsOptional()\n  page?: number;\n}\n'})}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"users.controller.ts"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:'@Controller("users")\nexport class UsersController {\n  constructor(private readonly usersService: UsersService) {}\n\n  @UseValidation("create")\n  @Post()\n  create(@Body() createUserDto: CreateUserDto) {\n    return this.usersService.create(createUserDto);\n  }\n\n  @UseValidation()\n  @Get()\n  findAll(@Query() pagintionDto: PagintionDto) {\n    return this.usersService.findAll(pagintionDto);\n  }\n\n  @Get(":id")\n  findOne(@Param("id") id: string) {\n    return this.usersService.findOne(+id);\n  }\n\n  @UseValidation("update")\n  @Patch(":id")\n  update(@Param("id") id: string, @Body() updateUserDto: UpdateUserDto) {\n    return this.usersService.update(+id, updateUserDto);\n  }\n\n  @Delete(":id")\n  remove(@Param("id") id: string) {\n    return this.usersService.remove(+id);\n  }\n}\n'})})]})}function d(e={}){const{wrapper:n}={...(0,r.a)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(p,{...e})}):p(e)}},7540:(e,n,t)=>{t.d(n,{Z:()=>a,a:()=>i});var s=t(959);const r={},o=s.createContext(r);function i(e){const n=s.useContext(o);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),s.createElement(o.Provider,{value:n},e.children)}}}]);